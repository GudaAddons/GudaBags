local addonName, ns = ...

local BankCharacters = {}
ns:RegisterModule("BankFrame.BankCharacters", BankCharacters)

local function GetDatabase()
    return ns:GetModule("Database")
end

local frame = nil
local onCharacterSelected = nil

local DROPDOWN_WIDTH = 160
local ROW_HEIGHT = 20
local PADDING = 8
local MAX_VISIBLE_ROWS = 10

local function HasBankData(fullName)
    local Database = GetDatabase()
    local bank = Database:GetBank(fullName)
    if not bank then return false end

    for bagID, bagData in pairs(bank) do
        if bagData.slots then
            for slot, _ in pairs(bagData.slots) do
                return true
            end
        end
    end

    return false
end

local function CreateDropdownFrame()
    local f = CreateFrame("Frame", "GudaBagsBankCharacterDropdown", UIParent, "BackdropTemplate")
    f:SetFrameStrata("DIALOG")
    f:SetFrameLevel(200)
    f:SetSize(DROPDOWN_WIDTH, 100)
    f:SetBackdrop({
        bgFile = "Interface\\Buttons\\WHITE8x8",
        edgeFile = "Interface\\Tooltips\\UI-Tooltip-Border",
        edgeSize = 14,
        insets = {left = 3, right = 3, top = 3, bottom = 3},
    })
    f:SetBackdropColor(0.1, 0.1, 0.1, 0.95)
    f:SetBackdropBorderColor(0.4, 0.4, 0.4, 1)
    f:EnableMouse(true)
    f:SetClampedToScreen(true)
    f:Hide()

    f:SetScript("OnShow", function()
        f:RegisterEvent("GLOBAL_MOUSE_DOWN")
    end)

    f:SetScript("OnHide", function()
        f:UnregisterEvent("GLOBAL_MOUSE_DOWN")
    end)

    f:SetScript("OnEvent", function(self, event)
        if event == "GLOBAL_MOUSE_DOWN" then
            if not self:IsMouseOver() then
                self:Hide()
            end
        end
    end)

    local scrollFrame = CreateFrame("ScrollFrame", nil, f, "UIPanelScrollFrameTemplate")
    scrollFrame:SetPoint("TOPLEFT", f, "TOPLEFT", PADDING, -PADDING)
    scrollFrame:SetPoint("BOTTOMRIGHT", f, "BOTTOMRIGHT", -PADDING - 20, PADDING)
    f.scrollFrame = scrollFrame

    local scrollBar = scrollFrame.ScrollBar or _G[scrollFrame:GetName() .. "ScrollBar"]
    if scrollBar then
        scrollBar:SetAlpha(0.7)
    end

    local content = CreateFrame("Frame", nil, scrollFrame)
    content:SetSize(DROPDOWN_WIDTH - PADDING * 2 - 20, 100)
    scrollFrame:SetScrollChild(content)
    f.content = content

    f.rows = {}

    return f
end

local function CreateRow(parent, index)
    local row = CreateFrame("Button", nil, parent)
    row:SetSize(DROPDOWN_WIDTH - PADDING * 2 - 20, ROW_HEIGHT)
    row:SetPoint("TOPLEFT", parent, "TOPLEFT", 0, -((index - 1) * ROW_HEIGHT))

    local highlight = row:CreateTexture(nil, "HIGHLIGHT")
    highlight:SetAllPoints()
    highlight:SetTexture("Interface\\Buttons\\WHITE8x8")
    highlight:SetVertexColor(1, 1, 1, 0.1)

    local nameText = row:CreateFontString(nil, "OVERLAY", "GameFontNormalSmall")
    nameText:SetPoint("LEFT", row, "LEFT", 4, 0)
    nameText:SetJustifyH("LEFT")
    row.nameText = nameText

    local statusText = row:CreateFontString(nil, "OVERLAY", "GameFontNormalSmall")
    statusText:SetPoint("RIGHT", row, "RIGHT", -4, 0)
    statusText:SetJustifyH("RIGHT")
    row.statusText = statusText

    return row
end

local function CreateMessageRow(parent)
    local row = CreateFrame("Frame", nil, parent)
    row:SetSize(DROPDOWN_WIDTH - PADDING * 2, ROW_HEIGHT * 2)

    local text = row:CreateFontString(nil, "OVERLAY", "GameFontNormalSmall")
    text:SetPoint("CENTER", row, "CENTER", 0, 0)
    text:SetWidth(DROPDOWN_WIDTH - PADDING * 2 - 8)
    text:SetJustifyH("CENTER")
    text:SetTextColor(0.6, 0.6, 0.6)
    row.text = text

    return row
end

local function PopulateDropdown()
    if not frame then return end

    local Database = GetDatabase()
    local characters = Database:GetAllCharacters(false, true)
    local currentFullName = Database:GetPlayerFullName()
    local BankFrame = ns:GetModule("BankFrame")
    local viewingCharacter = BankFrame:GetViewingCharacter()

    if frame.messageRow then
        frame.messageRow:Hide()
    end

    local rowCount = #characters + 1

    local contentHeight = rowCount * ROW_HEIGHT
    local visibleHeight = math.min(rowCount, MAX_VISIBLE_ROWS) * ROW_HEIGHT

    local needsScrollBar = rowCount > MAX_VISIBLE_ROWS
    local scrollBar = frame.scrollFrame.ScrollBar or _G[frame.scrollFrame:GetName() .. "ScrollBar"]
    local scrollBarWidth = needsScrollBar and 20 or 0

    if scrollBar then
        if needsScrollBar then
            scrollBar:Show()
        else
            scrollBar:Hide()
        end
    end

    frame.scrollFrame:SetPoint("BOTTOMRIGHT", frame, "BOTTOMRIGHT", -PADDING - scrollBarWidth, PADDING)
    local rowWidth = DROPDOWN_WIDTH - PADDING * 2 - scrollBarWidth

    frame.content:SetHeight(contentHeight)
    frame.content:SetWidth(rowWidth)
    frame:SetHeight(visibleHeight + PADDING * 2)

    while #frame.rows < rowCount do
        local row = CreateRow(frame.content, #frame.rows + 1)
        table.insert(frame.rows, row)
    end

    for i, row in ipairs(frame.rows) do
        if i <= rowCount then
            row:SetWidth(rowWidth)
        else
            row:Hide()
        end
    end

    local rowIndex = 1

    local currentRow = frame.rows[rowIndex]
    currentRow:SetPoint("TOPLEFT", frame.content, "TOPLEFT", 0, -((rowIndex - 1) * ROW_HEIGHT))

    if viewingCharacter then
        currentRow.nameText:SetText("|cff00ff00< Back to Current|r")
        currentRow.statusText:SetText("")
    else
        currentRow.nameText:SetText("|cffffffff(Current Character)|r")
        currentRow.statusText:SetText("")
    end

    currentRow:SetScript("OnClick", function()
        frame:Hide()
        if onCharacterSelected then
            onCharacterSelected(nil)
        end
    end)
    currentRow:Show()
    rowIndex = rowIndex + 1

    for _, char in ipairs(characters) do
        local row = frame.rows[rowIndex]
        row:SetPoint("TOPLEFT", frame.content, "TOPLEFT", 0, -((rowIndex - 1) * ROW_HEIGHT))

        local classColor = RAID_CLASS_COLORS[char.class]
        local r, g, b = 0.7, 0.7, 0.7
        if classColor then
            r, g, b = classColor.r, classColor.g, classColor.b
        end

        local isViewing = viewingCharacter == char.fullName
        local isCurrent = char.fullName == currentFullName

        local namePrefix = ""
        if isViewing then
            namePrefix = "|cff00ff00> |r"
        end

        row.nameText:SetText(namePrefix .. char.name)
        row.nameText:SetTextColor(r, g, b)

        local hasBankData = HasBankData(char.fullName)
        if hasBankData then
            row.statusText:SetText("|cff666666(" .. char.level .. ")|r")
        else
            row.statusText:SetText("|cff994444No data|r")
        end

        row:SetScript("OnClick", function()
            frame:Hide()
            if onCharacterSelected then
                if isCurrent then
                    onCharacterSelected(nil)
                else
                    onCharacterSelected(char.fullName, char)
                end
            end
        end)

        row:Show()
        rowIndex = rowIndex + 1
    end
end

function BankCharacters:Show(anchor)
    if not frame then
        frame = CreateDropdownFrame()
    end

    PopulateDropdown()

    frame:ClearAllPoints()
    frame:SetPoint("TOPLEFT", anchor, "BOTTOMLEFT", 0, -2)

    frame:Show()
end

function BankCharacters:Hide()
    if frame then
        frame:Hide()
    end
end

function BankCharacters:Toggle(anchor)
    if frame and frame:IsShown() then
        self:Hide()
    else
        self:Show(anchor)
    end
end

function BankCharacters:SetCallback(callback)
    onCharacterSelected = callback
end

function BankCharacters:IsShown()
    return frame and frame:IsShown()
end
